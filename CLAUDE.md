# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Run Commands

```bash
# Build (using Makefile)
make          # Format, vet, test, and build
make build    # Just build
make test     # Run tests
make clean    # Remove artifacts

# Build (using go directly)
go build -o rabbithole .

# Run (browser mode - shows topology explorer)
./rabbithole -url "amqp://user:pass@host:5672/"

# Run (direct consumer mode - bypasses browser)
./rabbithole -exchange myexchange -routing-key "#"

# Run with protobuf decoding
./rabbithole -exchange myexchange -proto /path/to/proto/files

# Run with SQLite persistence
./rabbithole -exchange myexchange -persist

# Run with custom database path
./rabbithole -exchange myexchange -persist -db /path/to/messages.db

# Run with custom management API URL
./rabbithole -url "amqp://user:pass@host:5672/" -management-url "http://host:15672"

# Install globally
go install github.com/epalmerini/rabbithole@latest
```

## Architecture

TUI application for consuming and inspecting RabbitMQ messages, built with Bubble Tea (Elm architecture).

### Package Structure

- `internal/tui/` - TUI layer (Bubble Tea models)
- `internal/rabbitmq/` - AMQP consumer + Management API client
- `internal/proto/` - Dynamic protobuf decoding
- `internal/db/` - SQLite persistence (sqlc-generated queries + async writer)

### TUI Views

Three views managed by `appModel` in `app.go`:
1. **Browser** (`browserModel`) - Topology explorer
2. **Consumer** (`model`) - Message consumption with split-pane display. Has a **replay mode** for viewing historical sessions without AMQP.
3. **Session browser** (`sessionBrowserModel`) - Browse/replay/delete past sessions from SQLite, with FTS5 content search.

Navigation flow: `s` (browser → sessions), `b` (sessions → browser), `b` from replay consumer → session browser (not topology browser).

### Key Design Decisions

- **VimKeyState** (`keyhandler.go`): Stateful key handler with multi-key sequences (`gg`, `zz`), numeric prefixes (`5j`), and 500ms timeout. Only used in consumer view; browser/session views use direct key checks.
- **Protobuf scoring**: Decoder tries all known message types, scores by populated field count, boosts for types matching routing key segments.
- **SQLite**: Pure Go via `modernc.org/sqlite` (no CGO). Queries generated by `sqlc` from `query.sql`; FTS5 queries use raw SQL in `store.go` (sqlc doesn't support virtual tables).
- **Async persistence**: `AsyncWriter` buffers messages (channel of 1000) for non-blocking writes. Drops if full. Drains on shutdown.
- **Replay mode**: `initialReplayModel()` in `tui.go` creates a consumer pre-loaded with DB messages, `store=nil`, no AMQP connection. Status bar shows `▶ Replay`, pause is disabled.
