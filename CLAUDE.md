# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Run Commands

```bash
# Build (using Makefile)
make          # Format, vet, test, and build
make build    # Just build
make test     # Run tests
make clean    # Remove artifacts

# Build (using go directly)
go build -o rabbithole .

# Run (uses config file at ~/.config/rabbithole/config.toml)
./rabbithole

# Run with AMQP_URL env var (no config file needed)
AMQP_URL="amqp://user:pass@host:5672/" ./rabbithole

# Install globally
go install github.com/epalmerini/rabbithole@latest
```

## Configuration

Config file: `~/.config/rabbithole/config.toml` (or `$XDG_CONFIG_HOME/rabbithole/config.toml`).
See `config.example.toml` for all options.

Startup flow:
- 2+ profiles → profile picker → browser
- 1 profile → straight to browser
- 0 profiles + `AMQP_URL`/`RABBITMQ_URL` env var → browser
- 0 profiles + no env var → URL prompt → browser

Persistence (SQLite) is always on. Database: `~/.local/share/rabbithole/rabbithole.db`.
The only CLI flag is `--version`.

## Architecture

TUI application for consuming and inspecting RabbitMQ messages, built with Bubble Tea (Elm architecture).

### Package Structure

- `internal/tui/` - TUI layer (Bubble Tea models)
- `internal/config/` - TOML config loading, profile resolution, preferences persistence
- `internal/xdg/` - XDG Base Directory helpers
- `internal/rabbitmq/` - AMQP consumer + Management API client
- `internal/proto/` - Dynamic protobuf decoding
- `internal/db/` - SQLite persistence (sqlc-generated queries + async writer)

### TUI Views

Five views managed by `appModel` in `app.go`:
1. **Profile picker** (`profilePickerModel`) - Shown when 2+ profiles exist
2. **URL prompt** (`urlPromptModel`) - Shown when no profiles and no env var
3. **Browser** (`browserModel`) - Topology explorer
4. **Consumer** (`model`) - Message consumption with split-pane display. Has a **replay mode** for viewing historical sessions without AMQP.
5. **Session browser** (`sessionBrowserModel`) - Browse/replay/delete past sessions from SQLite, with FTS5 content search.

Navigation flow: profile picker/URL prompt → browser, `s` (browser → sessions), `b` (sessions → browser), `b` from replay consumer → session browser (not topology browser).

### Key Design Decisions

- **VimKeyState** (`keyhandler.go`): Stateful key handler with multi-key sequences (`gg`, `zz`), numeric prefixes (`5j`), and 500ms timeout. Only used in consumer view; browser/session views use direct key checks.
- **Protobuf scoring**: Decoder tries all known message types, scores by populated field count, boosts for types matching routing key segments.
- **SQLite**: Pure Go via `modernc.org/sqlite` (no CGO). Queries generated by `sqlc` from `query.sql`; FTS5 queries use raw SQL in `store.go` (sqlc doesn't support virtual tables).
- **Async persistence**: `AsyncWriter` buffers messages (channel of 1000) for non-blocking writes. Drops if full. Drains on shutdown.
- **Replay mode**: `initialReplayModel()` in `tui.go` creates a consumer pre-loaded with DB messages, `store=nil`, no AMQP connection. Status bar shows `▶ Replay`, pause is disabled.
